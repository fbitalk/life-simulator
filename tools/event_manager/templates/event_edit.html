{% extends "base.html" %}

{% block title %}ç¼–è¾‘: {{ event.title }}{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-sep">/</span>
<a href="{{ url_for('category', filename=filename) }}">{{ display_name }}</a>
<span class="breadcrumb-sep">/</span>
<a href="{{ url_for('tag_events', filename=filename, tag_name=tag_name) }}">{{ tag_name }}</a>
<span class="breadcrumb-sep">/</span>
<span>{{ event_id }}</span>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>âœï¸ ç¼–è¾‘äº‹ä»¶</h1>
    <p class="subtitle">{{ event_id }}</p>
</div>

<form action="{{ url_for('event_edit', filename=filename, tag_name=tag_name, event_id=event_id) }}" method="post"
    class="event-form" id="eventForm">

    <div class="form-section">
        <h2>åŸºæœ¬ä¿¡æ¯</h2>

        <div class="form-group">
            <label for="title">äº‹ä»¶æ ‡é¢˜ *</label>
            <input type="text" id="title" name="title" value="{{ event.title }}" required>
        </div>

        <div class="form-group">
            <label for="description">äº‹ä»¶æè¿° *</label>
            <textarea id="description" name="description" rows="4" required>{{ event.description }}</textarea>
            <p class="form-hint">ä½¿ç”¨ {user} ä½œä¸ºç©å®¶åå­—çš„å ä½ç¬¦</p>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="priority">ä¼˜å…ˆçº§</label>
                <input type="number" id="priority" name="priority" value="{{ event.priority|default(0) }}" min="0">
                <p class="form-hint">æ•°å­—è¶Šå¤§è¶Šä¼˜å…ˆè§¦å‘</p>
            </div>

            <div class="form-group form-checkbox">
                <label>
                    <input type="checkbox" name="is_continue" {% if event.is_continue %}checked{% endif %}>
                    è¿ç»­äº‹ä»¶ (is_continue)
                </label>
                <p class="form-hint">å‹¾é€‰ååªèƒ½é€šè¿‡ continue_event è§¦å‘</p>
            </div>

            <div class="form-group form-checkbox">
                <label>
                    <input type="checkbox" name="allow_repeat" {% if event.allow_repeat %}checked{% endif %}>
                    å…è®¸é‡å¤è§¦å‘ (allow_repeat)
                </label>
                <p class="form-hint">å‹¾é€‰åè¯¥äº‹ä»¶å¯ä»¥åœ¨åŒä¸€å±€æ¸¸æˆä¸­å¤šæ¬¡è§¦å‘</p>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h2>è§¦å‘æ¡ä»¶</h2>
        <details>
            <summary class="section-summary">ç‚¹å‡»å±•å¼€/æ”¶èµ·è§¦å‘æ¡ä»¶è®¾ç½®</summary>
            <div class="details-content">

                <div class="form-row">
                    <div class="form-group">
                        <label>å¹´é¾„èŒƒå›´ (age_range)</label>
                        <div class="range-inputs">
                            <input type="number" name="age_min" placeholder="æœ€å°å¹´é¾„" min="0" max="666"
                                value="{{ event.trigger_conditions.age_range[0] if event.trigger_conditions and event.trigger_conditions.age_range else '' }}">
                            <span class="range-sep">è‡³</span>
                            <input type="number" name="age_max" placeholder="æœ€å¤§å¹´é¾„" min="0" max="666"
                                value="{{ event.trigger_conditions.age_range[1] if event.trigger_conditions and event.trigger_conditions.age_range else '' }}">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>æœ€ä½å±æ€§è¦æ±‚ (min_attributes)</label>
                    <div class="attributes-grid">
                        {% set min_attrs = event.trigger_conditions.min_attributes if event.trigger_conditions and
                        event.trigger_conditions.min_attributes else {} %}
                        <div class="attr-input">
                            <span>å¥åº·</span>
                            <input type="number" name="min_health" placeholder="-"
                                value="{{ min_attrs.health if min_attrs.health is defined else '' }}">
                        </div>
                        <div class="attr-input">
                            <span>é‡‘é’±</span>
                            <input type="number" name="min_money" placeholder="-"
                                value="{{ min_attrs.money if min_attrs.money is defined else '' }}">
                        </div>
                        <div class="attr-input">
                            <span>ç¤¾äº¤</span>
                            <input type="number" name="min_social" placeholder="-"
                                value="{{ min_attrs.social if min_attrs.social is defined else '' }}">
                        </div>
                        <div class="attr-input">
                            <span>æ™ºåŠ›</span>
                            <input type="number" name="min_intelligence" placeholder="-"
                                value="{{ min_attrs.intelligence if min_attrs.intelligence is defined else '' }}">
                        </div>
                        <div class="attr-input">
                            <span>å¹¸è¿</span>
                            <input type="number" name="min_luck" placeholder="-"
                                value="{{ min_attrs.luck if min_attrs.luck is defined else '' }}">
                        </div>
                        <div class="attr-input">
                            <span>ç†æ™º</span>
                            <input type="number" name="min_san" placeholder="-"
                                value="{{ min_attrs.san if min_attrs.san is defined else '' }}">
                        </div>
                        <div class="attr-input">
                            <span>ç¥ç§˜</span>
                            <input type="number" name="min_mystery" placeholder="-"
                                value="{{ min_attrs.mystery if min_attrs.mystery is defined else '' }}">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>æœ€é«˜å±æ€§é™åˆ¶ (max_attributes)</label>
                    <div class="attributes-grid">
                        {% set max_attrs = event.trigger_conditions.max_attributes if event.trigger_conditions and
                        event.trigger_conditions.max_attributes else {} %}
                        <div class="attr-input">
                            <span>å¥åº·</span>
                            <input type="number" name="max_health" placeholder="-"
                                value="{{ max_attrs.health if max_attrs.health is defined else '' }}">
                        </div>
                        <div class="attr-input">
                            <span>é‡‘é’±</span>
                            <input type="number" name="max_money" placeholder="-"
                                value="{{ max_attrs.money if max_attrs.money is defined else '' }}">
                        </div>
                        <div class="attr-input">
                            <span>ç¤¾äº¤</span>
                            <input type="number" name="max_social" placeholder="-"
                                value="{{ max_attrs.social if max_attrs.social is defined else '' }}">
                        </div>
                        <div class="attr-input">
                            <span>æ™ºåŠ›</span>
                            <input type="number" name="max_intelligence" placeholder="-"
                                value="{{ max_attrs.intelligence if max_attrs.intelligence is defined else '' }}">
                        </div>
                        <div class="attr-input">
                            <span>å¹¸è¿</span>
                            <input type="number" name="max_luck" placeholder="-"
                                value="{{ max_attrs.luck if max_attrs.luck is defined else '' }}">
                        </div>
                        <div class="attr-input">
                            <span>ç†æ™º</span>
                            <input type="number" name="max_san" placeholder="-"
                                value="{{ max_attrs.san if max_attrs.san is defined else '' }}">
                        </div>
                        <div class="attr-input">
                            <span>ç¥ç§˜</span>
                            <input type="number" name="max_mystery" placeholder="-"
                                value="{{ max_attrs.mystery if max_attrs.mystery is defined else '' }}">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>ä¸´æ—¶å±æ€§è¦æ±‚ (temp)</label>
                    <div class="range-inputs">
                        <input type="number" name="min_temp" placeholder="æœ€ä½å€¼"
                            value="{{ event.trigger_conditions.min_temp if event.trigger_conditions and event.trigger_conditions.min_temp is defined else '' }}">
                        <span class="range-sep">è‡³</span>
                        <input type="number" name="max_temp" placeholder="æœ€é«˜å€¼"
                            value="{{ event.trigger_conditions.max_temp if event.trigger_conditions and event.trigger_conditions.max_temp is defined else '' }}">
                    </div>
                    <p class="form-hint">ä¸´æ—¶å±æ€§æ¡ä»¶ï¼Œç”¨äºè¿ç»­äº‹ä»¶åˆ†æ”¯</p>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="required_tags">å¿…éœ€æ ‡ç­¾ (required_tags)</label>
                        <input type="text" id="required_tags" name="required_tags" placeholder="ç”¨é€—å·åˆ†éš”å¤šä¸ªæ ‡ç­¾"
                            value="{{ event.trigger_conditions.required_tags|join(', ') if event.trigger_conditions and event.trigger_conditions.required_tags else '' }}">
                        <p class="form-hint">ç©å®¶å¿…é¡»æ‹¥æœ‰è¿™äº›æ ‡ç­¾æ‰ä¼šè§¦å‘</p>
                    </div>
                    <div class="form-group">
                        <label for="excluded_tags">æ’é™¤æ ‡ç­¾ (excluded_tags)</label>
                        <input type="text" id="excluded_tags" name="excluded_tags" placeholder="ç”¨é€—å·åˆ†éš”å¤šä¸ªæ ‡ç­¾"
                            value="{{ event.trigger_conditions.excluded_tags|join(', ') if event.trigger_conditions and event.trigger_conditions.excluded_tags else '' }}">
                        <p class="form-hint">æ‹¥æœ‰è¿™äº›æ ‡ç­¾çš„ç©å®¶ä¸ä¼šè§¦å‘</p>
                    </div>
                </div>
            </div>
        </details>
    </div>

    <div class="form-section">
        <h2>é€‰é¡¹åˆ—è¡¨</h2>
        <p class="section-hint">ç©å®¶å¯ä»¥é€‰æ‹©çš„é€‰é¡¹</p>

        <div id="optionsContainer">
            {% for option in event.options %}
            {% set outer_loop = loop %}
            <div class="option-card" data-index="{{ loop.index0 }}">
                <div class="option-header">
                    <span class="option-number">é€‰é¡¹ {{ loop.index }}</span>
                    <button type="button" class="btn btn-danger btn-small" onclick="removeOption(this)">åˆ é™¤é€‰é¡¹</button>
                </div>

                <div class="form-group">
                    <label>é€‰é¡¹æ–‡æœ¬ *</label>
                    <input type="text" name="option_text_{{ loop.index0 }}" value="{{ option.text }}" required>
                </div>

                <div class="form-group">
                    <label>ç»“æœæè¿°</label>
                    <textarea name="option_result_{{ loop.index0 }}" rows="2">{{ option.result }}</textarea>
                </div>

                <div class="form-group">
                    <label>å±æ€§æ•ˆæœ (effects)</label>
                    <div class="effects-grid">
                        {% set effects = option.effects if option.effects else {} %}
                        <div class="effect-input">
                            <span>å¥åº·</span>
                            <input type="number" name="option_effect_health_{{ loop.index0 }}"
                                value="{{ effects.health if effects.health is defined else '' }}">
                        </div>
                        <div class="effect-input">
                            <span>é‡‘é’±</span>
                            <input type="number" name="option_effect_money_{{ loop.index0 }}"
                                value="{{ effects.money if effects.money is defined else '' }}">
                        </div>
                        <div class="effect-input">
                            <span>ç¤¾äº¤</span>
                            <input type="number" name="option_effect_social_{{ loop.index0 }}"
                                value="{{ effects.social if effects.social is defined else '' }}">
                        </div>
                        <div class="effect-input">
                            <span>æ™ºåŠ›</span>
                            <input type="number" name="option_effect_intelligence_{{ loop.index0 }}"
                                value="{{ effects.intelligence if effects.intelligence is defined else '' }}">
                        </div>
                        <div class="effect-input">
                            <span>å¹¸è¿</span>
                            <input type="number" name="option_effect_luck_{{ loop.index0 }}"
                                value="{{ effects.luck if effects.luck is defined else '' }}">
                        </div>
                        <div class="effect-input">
                            <span>ç†æ™º</span>
                            <input type="number" name="option_effect_san_{{ loop.index0 }}"
                                value="{{ effects.san if effects.san is defined else '' }}">
                        </div>
                        <div class="effect-input">
                            <span>ç¥ç§˜</span>
                            <input type="number" name="option_effect_mystery_{{ loop.index0 }}"
                                value="{{ effects.mystery if effects.mystery is defined else '' }}">
                        </div>
                        <div class="effect-input">
                            <span>ä¸´æ—¶(temp)</span>
                            <input type="number" name="option_effect_temp_{{ loop.index0 }}"
                                value="{{ effects.temp if effects.temp is defined else '' }}">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>æ·»åŠ æ ‡ç­¾ (add_tags)</label>
                        <input type="text" name="option_add_tags_{{ loop.index0 }}" placeholder="ç”¨é€—å·åˆ†éš”"
                            value="{{ option.add_tags|join(', ') if option.add_tags else '' }}">
                    </div>
                    <div class="form-group">
                        <label>ç§»é™¤æ ‡ç­¾ (remove_tags)</label>
                        <input type="text" name="option_remove_tags_{{ loop.index0 }}" placeholder="ç”¨é€—å·åˆ†éš”"
                            value="{{ option.remove_tags|join(', ') if option.remove_tags else '' }}">
                    </div>
                </div>

                <details class="advanced-settings">
                    <summary>é«˜çº§é€‰é¡¹è®¾ç½® (ç‚¹å‡»å±•å¼€) <span class="advanced-status status-disabled">æœªå¯ç”¨</span></summary>
                    <div class="details-content">

                        <div class="form-group">
                            <label>ç›´æ¥è®¾ç½®å±æ€§ (set_attributes)</label>
                            <div class="effects-grid">
                                {% set set_attrs = option.set_attributes if option.set_attributes else {} %}
                                <div class="effect-input">
                                    <span>å¥åº·</span>
                                    <input type="number" name="option_set_health_{{ loop.index0 }}"
                                        value="{{ set_attrs.health if set_attrs.health is defined else '' }}"
                                        placeholder="è®¾ä¸º">
                                </div>
                                <div class="effect-input">
                                    <span>é‡‘é’±</span>
                                    <input type="number" name="option_set_money_{{ loop.index0 }}"
                                        value="{{ set_attrs.money if set_attrs.money is defined else '' }}"
                                        placeholder="è®¾ä¸º">
                                </div>
                                <div class="effect-input">
                                    <span>ç¤¾äº¤</span>
                                    <input type="number" name="option_set_social_{{ loop.index0 }}"
                                        value="{{ set_attrs.social if set_attrs.social is defined else '' }}"
                                        placeholder="è®¾ä¸º">
                                </div>
                                <div class="effect-input">
                                    <span>æ™ºåŠ›</span>
                                    <input type="number" name="option_set_intelligence_{{ loop.index0 }}"
                                        value="{{ set_attrs.intelligence if set_attrs.intelligence is defined else '' }}"
                                        placeholder="è®¾ä¸º">
                                </div>
                                <div class="effect-input">
                                    <span>å¹¸è¿</span>
                                    <input type="number" name="option_set_luck_{{ loop.index0 }}"
                                        value="{{ set_attrs.luck if set_attrs.luck is defined else '' }}"
                                        placeholder="è®¾ä¸º">
                                </div>
                                <div class="effect-input">
                                    <span>ç†æ™º</span>
                                    <input type="number" name="option_set_san_{{ loop.index0 }}"
                                        value="{{ set_attrs.san if set_attrs.san is defined else '' }}"
                                        placeholder="è®¾ä¸º">
                                </div>
                                <div class="effect-input">
                                    <span>ç¥ç§˜</span>
                                    <input type="number" name="option_set_mystery_{{ loop.index0 }}"
                                        value="{{ set_attrs.mystery if set_attrs.mystery is defined else '' }}"
                                        placeholder="è®¾ä¸º">
                                </div>
                            </div>
                            <p class="form-hint">ç›´æ¥å°†å±æ€§è®¾ä¸ºæŒ‡å®šå€¼ï¼ˆéå¢å‡ï¼‰</p>
                        </div>

                        <div class="form-group">
                            <label>è®¾ç½®ä¸´æ—¶å±æ€§ (set_temp)</label>
                            <input type="number" name="option_set_temp_{{ loop.index0 }}" placeholder="å°†ä¸´æ—¶å±æ€§è®¾ä¸º..."
                                value="{{ set_attrs.temp if set_attrs.temp is defined else '' }}">
                            <p class="form-hint">è®¾ç½®ä¸´æ—¶å±æ€§å€¼ï¼ˆç”¨äºè¿ç»­äº‹ä»¶åˆ†æ”¯ï¼‰</p>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>åç»­äº‹ä»¶ (continue_event)</label>
                                <input type="text" name="option_continue_event_{{ loop.index0 }}"
                                    placeholder="äº‹ä»¶IDï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”"
                                    value="{% if option.continue_event is iterable and option.continue_event is not string %}{{ option.continue_event|join(', ') }}{% else %}{{ option.continue_event if option.continue_event else '' }}{% endif %}">
                                <p class="form-hint">æ”¯æŒå¤šä¸ªäº‹ä»¶IDï¼ˆé€—å·åˆ†éš”ï¼‰ï¼Œå°†éšæœºé€‰å–ä¸€ä¸ª</p>
                            </div>
                            <div class="form-group">
                                <label>æ­»äº¡é£é™© (risk)</label>
                                <input type="number" name="option_risk_{{ loop.index0 }}" step="0.01" min="0" max="1"
                                    placeholder="0-1" value="{{ option.risk if option.risk is defined else '' }}">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>æ­»äº¡æè¿° (death_reason)</label>
                            <input type="text" name="option_death_reason_{{ loop.index0 }}" placeholder="é£é™©è§¦å‘æ—¶çš„æ­»å› æè¿°"
                                value="{{ option.death_reason if option.death_reason else '' }}">
                        </div>

                        <div class="form-row">
                            <div class="form-group form-checkbox">
                                <label>
                                    <input type="checkbox" name="option_death_flag_{{ loop.index0 }}" {% if
                                        option.death_flag %}checked{% endif %}>
                                    ç›´æ¥è‡´æ­» (death_flag)
                                </label>
                                <p class="form-hint">å‹¾é€‰åé€‰æ‹©æ­¤é€‰é¡¹ç›´æ¥å¯¼è‡´æ­»äº¡</p>
                            </div>
                        </div>

                        <div class="form-group conditional-results-section">
                            <label>æ¡ä»¶ç»“æœ (conditional_results) <span class="optional-badge">é«˜çº§</span></label>

                            <div class="conditional-results-container" data-option-index="{{ loop.index0 }}">
                                {% if option.conditional_results %}
                                {% for cond in option.conditional_results %}
                                <div class="conditional-result-item" data-cond-index="{{ loop.index0 }}">
                                    <div class="cond-header">
                                        <span>æ¡ä»¶ {{ loop.index }}</span>
                                        <button type="button" class="btn btn-danger btn-small"
                                            onclick="removeConditionalResult(this)">åˆ é™¤</button>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>æ¡ä»¶ç±»å‹</label>
                                            <select name="option_{{ outer_loop.index0 }}_cond_{{ loop.index0 }}_type"
                                                class="cond-type-select" onchange="toggleConditionFields(this)">
                                                <option value="attributes" {% if cond.conditions.min_attributes or
                                                    cond.conditions.max_attributes %}selected{% endif %}>å±æ€§æ¡ä»¶</option>
                                                <option value="temp" {% if cond.conditions.min_temp is defined or
                                                    cond.conditions.max_temp is defined %}selected{% endif %}>ä¸´æ—¶å±æ€§
                                                </option>
                                                <option value="tags" {% if cond.conditions.required_tags %}selected{%
                                                    endif %}>
                                                    æ ‡ç­¾æ¡ä»¶</option>
                                                <option value="default" {% if cond.conditions.default %}selected{% endif
                                                    %}>
                                                    é»˜è®¤ï¼ˆå…œåº•ï¼‰</option>
                                            </select>
                                        </div>

                                        <!-- Attribute Fields -->
                                        <div class="form-group cond-field-group cond-attr-fields">
                                            <label>å±æ€§å</label>
                                            <select name="option_{{ outer_loop.index0 }}_cond_{{ loop.index0 }}_attr">
                                                <option value="">--</option>
                                                <option value="health" {% if cond.conditions.min_attributes and
                                                    cond.conditions.min_attributes.health is defined %}selected{% endif
                                                    %}>å¥åº·
                                                </option>
                                                <option value="money" {% if cond.conditions.min_attributes and
                                                    cond.conditions.min_attributes.money is defined %}selected{% endif
                                                    %}>é‡‘é’±
                                                </option>
                                                <option value="intelligence" {% if cond.conditions.min_attributes and
                                                    cond.conditions.min_attributes.intelligence is defined %}selected{%
                                                    endif %}>æ™ºåŠ›</option>
                                                <option value="luck" {% if cond.conditions.min_attributes and
                                                    cond.conditions.min_attributes.luck is defined %}selected{% endif
                                                    %}>å¹¸è¿
                                                </option>
                                                <option value="social" {% if cond.conditions.min_attributes and
                                                    cond.conditions.min_attributes.social is defined %}selected{% endif
                                                    %}>ç¤¾äº¤
                                                </option>
                                                <option value="san" {% if cond.conditions.min_attributes and
                                                    cond.conditions.min_attributes.san is defined %}selected{% endif
                                                    %}>ç†æ™º
                                                </option>
                                                <option value="mystery" {% if cond.conditions.min_attributes and
                                                    cond.conditions.min_attributes.mystery is defined %}selected{% endif
                                                    %}>ç¥ç§˜
                                                </option>
                                            </select>
                                        </div>
                                        <div class="form-group cond-field-group cond-attr-fields">
                                            <label>æœ€ä½å€¼</label>
                                            <input type="number"
                                                name="option_{{ outer_loop.index0 }}_cond_{{ loop.index0 }}_min"
                                                value="{% if cond.conditions.min_attributes %}{{ cond.conditions.min_attributes.values()|list|first }}{% endif %}">
                                        </div>

                                        <!-- Temp Fields -->
                                        <div class="form-group cond-field-group cond-temp-fields" style="display:none">
                                            <label>ä¸´æ—¶å±æ€§æœ€ä½å€¼</label>
                                            <input type="number"
                                                name="option_{{ outer_loop.index0 }}_cond_{{ loop.index0 }}_temp_min"
                                                value="{% if cond.conditions.min_temp is defined %}{{ cond.conditions.min_temp }}{% endif %}">
                                        </div>

                                        <!-- Tag Fields -->
                                        <div class="form-group cond-field-group cond-tag-fields" style="display:none">
                                            <label>å¿…éœ€æ ‡ç­¾</label>
                                            <input type="text"
                                                name="option_{{ outer_loop.index0 }}_cond_{{ loop.index0 }}_tags"
                                                placeholder="é€—å·åˆ†éš”"
                                                value="{{ cond.conditions.required_tags|join(', ') if cond.conditions.required_tags else '' }}">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>ç»“æœæè¿° *</label>
                                        <input type="text"
                                            name="option_{{ outer_loop.index0 }}_cond_{{ loop.index0 }}_result"
                                            value="{{ cond.result }}" required>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>æ•ˆæœ (æ•ˆæœå±æ€§:å€¼)</label>
                                            <input type="text"
                                                name="option_{{ outer_loop.index0 }}_cond_{{ loop.index0 }}_effects"
                                                placeholder="health:10, money:-5"
                                                value="{% if cond.effects %}{% for k,v in cond.effects.items() %}{{ k }}:{{ v }}{% if not loop.last %}, {% endif %}{% endfor %}{% endif %}">
                                        </div>
                                        <div class="form-group">
                                            <label>æ·»åŠ æ ‡ç­¾</label>
                                            <input type="text"
                                                name="option_{{ outer_loop.index0 }}_cond_{{ loop.index0 }}_add_tags"
                                                placeholder="é€—å·åˆ†éš”"
                                                value="{{ cond.add_tags|join(', ') if cond.add_tags else '' }}">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>åç»­äº‹ä»¶</label>
                                        <input type="text"
                                            name="option_{{ outer_loop.index0 }}_cond_{{ loop.index0 }}_continue"
                                            placeholder="äº‹ä»¶IDï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”"
                                            value="{% if cond.continue_event is iterable and cond.continue_event is not string %}{{ cond.continue_event|join(', ') }}{% else %}{{ cond.continue_event if cond.continue_event else '' }}{% endif %}">
                                    </div>
                                </div>
                                {% endfor %}
                                {% endif %}
                            </div>
                            <button type="button" class="btn btn-secondary btn-small"
                                onclick="addConditionalResult({{ loop.index0 }})">+ æ·»åŠ æ¡ä»¶ç»“æœ</button>

                            <details class="json-fallback">
                                <summary>æˆ–ç›´æ¥ç¼–è¾‘ JSON</summary>
                                <textarea name="option_conditional_results_{{ loop.index0 }}" rows="4"
                                    class="code-editor"
                                    placeholder='[{"conditions": {"min_attributes": {"luck": 80}}, "result": "å¹¸è¿ç»“æœ", "effects": {"money": 100}}]'>{{ option.conditional_results|json_dumps if option.conditional_results else '' }}</textarea>
                            </details>
                            <p class="form-hint">æ·»åŠ å¤šä¸ªæ¡ä»¶ç»“æœï¼Œç³»ç»ŸæŒ‰é¡ºåºæ£€æŸ¥ï¼ŒåŒ¹é…ç¬¬ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„ç»“æœ</p>
                        </div>
                    </div>
                </details>
            </div>
            {% endfor %}
        </div>

        <button type="button" class="btn btn-secondary" onclick="addOption()">+ æ·»åŠ æ–°é€‰é¡¹</button>
    </div>

    <input type="hidden" name="option_count" id="optionCount" value="{{ event.options|length }}">

    <div class="form-actions">
        <button type="submit" class="btn btn-primary btn-large">ğŸ’¾ ä¿å­˜äº‹ä»¶</button>
        <a href="{{ url_for('tag_events', filename=filename, tag_name=tag_name) }}" class="btn btn-secondary">å–æ¶ˆ</a>
    </div>
</form>

<div class="raw-data-section">
    <details>
        <summary>æŸ¥çœ‹å®Œæ•´JSONæ•°æ®</summary>
        <pre class="raw-json">{{ event|json_dumps }}</pre>
    </details>
</div>
{% endblock %}

{% block scripts %}
<script>
    let optionCount = {{ event.options| length }};

    function addOption() {
        const container = document.getElementById('optionsContainer');
        const index = optionCount;

        const optionHtml = `
        <div class="option-card" data-index="${index}">
            <div class="option-header">
                <span class="option-number">é€‰é¡¹ ${index + 1}</span>
                <button type="button" class="btn btn-danger btn-small" onclick="removeOption(this)">åˆ é™¤é€‰é¡¹</button>
            </div>
            
            <div class="form-group">
                <label>é€‰é¡¹æ–‡æœ¬ *</label>
                <input type="text" name="option_text_${index}" required>
            </div>
            
            <div class="form-group">
                <label>ç»“æœæè¿°</label>
                <textarea name="option_result_${index}" rows="2"></textarea>
            </div>
            
            <div class="form-group">
                <label>å±æ€§æ•ˆæœ (effects)</label>
                <div class="effects-grid">
                    <div class="effect-input"><span>å¥åº·</span><input type="number" name="option_effect_health_${index}"></div>
                    <div class="effect-input"><span>é‡‘é’±</span><input type="number" name="option_effect_money_${index}"></div>
                    <div class="effect-input"><span>ç¤¾äº¤</span><input type="number" name="option_effect_social_${index}"></div>
                    <div class="effect-input"><span>æ™ºåŠ›</span><input type="number" name="option_effect_intelligence_${index}"></div>
                    <div class="effect-input"><span>å¹¸è¿</span><input type="number" name="option_effect_luck_${index}"></div>
                    <div class="effect-input"><span>ç†æ™º</span><input type="number" name="option_effect_san_${index}"></div>
                    <div class="effect-input"><span>ç¥ç§˜</span><input type="number" name="option_effect_mystery_${index}"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label>ç›´æ¥è®¾ç½®å±æ€§ (set_attributes)</label>
                <div class="effects-grid">
                    <div class="effect-input"><span>å¥åº·</span><input type="number" name="option_set_health_${index}" placeholder="è®¾ä¸º"></div>
                    <div class="effect-input"><span>é‡‘é’±</span><input type="number" name="option_set_money_${index}" placeholder="è®¾ä¸º"></div>
                    <div class="effect-input"><span>ç¤¾äº¤</span><input type="number" name="option_set_social_${index}" placeholder="è®¾ä¸º"></div>
                    <div class="effect-input"><span>æ™ºåŠ›</span><input type="number" name="option_set_intelligence_${index}" placeholder="è®¾ä¸º"></div>
                    <div class="effect-input"><span>å¹¸è¿</span><input type="number" name="option_set_luck_${index}" placeholder="è®¾ä¸º"></div>
                    <div class="effect-input"><span>ç†æ™º</span><input type="number" name="option_set_san_${index}" placeholder="è®¾ä¸º"></div>
                    <div class="effect-input"><span>ç¥ç§˜</span><input type="number" name="option_set_mystery_${index}" placeholder="è®¾ä¸º"></div>
                </div>
                <p class="form-hint">ç›´æ¥å°†å±æ€§è®¾ä¸ºæŒ‡å®šå€¼ï¼ˆéå¢å‡ï¼‰</p>
            </div>
            
            <div class="form-group">
                <label>è®¾ç½®ä¸´æ—¶å±æ€§ (set_temp)</label>
                <input type="number" name="option_set_temp_${index}" placeholder="å°†ä¸´æ—¶å±æ€§è®¾ä¸º...">
                <p class="form-hint">è®¾ç½®ä¸´æ—¶å±æ€§å€¼ï¼ˆç”¨äºè¿ç»­äº‹ä»¶åˆ†æ”¯ï¼‰</p>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>æ·»åŠ æ ‡ç­¾ (add_tags)</label>
                    <input type="text" name="option_add_tags_${index}" placeholder="ç”¨é€—å·åˆ†éš”">
                </div>
                <div class="form-group">
                    <label>ç§»é™¤æ ‡ç­¾ (remove_tags)</label>
                    <input type="text" name="option_remove_tags_${index}" placeholder="ç”¨é€—å·åˆ†éš”">
                </div>
            </div>
            
            <details class="advanced-settings">
                <summary>é«˜çº§é€‰é¡¹è®¾ç½® (ç‚¹å‡»å±•å¼€) <span class="advanced-status status-disabled">æœªå¯ç”¨</span></summary>
                <div class="details-content">
            
            <div class="form-row">
                <div class="form-group">
                    <label>åç»­äº‹ä»¶ (continue_event)</label>
                    <input type="text" name="option_continue_event_${index}" placeholder="äº‹ä»¶IDï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”">
                    <p class="form-hint">æ”¯æŒå¤šä¸ªäº‹ä»¶IDï¼ˆé€—å·åˆ†éš”ï¼‰ï¼Œå°†éšæœºé€‰å–ä¸€ä¸ª</p>
                </div>
                <div class="form-group">
                    <label>æ­»äº¡é£é™© (risk)</label>
                    <input type="number" name="option_risk_${index}" step="0.01" min="0" max="1" placeholder="0-1">
                </div>
            </div>
            
            <div class="form-group">
                <label>æ­»äº¡æè¿° (death_reason)</label>
                <input type="text" name="option_death_reason_${index}" placeholder="é£é™©è§¦å‘æ—¶çš„æ­»å› æè¿°">
            </div>
            
            <div class="form-row">
                <div class="form-group form-checkbox">
                    <label>
                        <input type="checkbox" name="option_death_flag_${index}">
                        ç›´æ¥è‡´æ­» (death_flag)
                    </label>
                    <p class="form-hint">å‹¾é€‰åé€‰æ‹©æ­¤é€‰é¡¹ç›´æ¥å¯¼è‡´æ­»äº¡</p>
                </div>
            </div>
            
            <div class="form-group">
                <label>æ¡ä»¶ç»“æœ (conditional_results) <span class="optional-badge">é«˜çº§</span></label>
                <textarea name="option_conditional_results_${index}" rows="4" class="code-editor" 
                    placeholder='[{"conditions": {"min_attributes": {"luck": 80}}, "result": "å¹¸è¿ç»“æœ", "effects": {"money": 100}}]'></textarea>
                <p class="form-hint">JSONæ•°ç»„æ ¼å¼ï¼Œæ ¹æ®ä¸åŒæ¡ä»¶è§¦å‘ä¸åŒç»“æœ</p>
            </div>
            </div>
            </details>
        </div>
    `;

        container.insertAdjacentHTML('beforeend', optionHtml);
        optionCount++;
        document.getElementById('optionCount').value = optionCount;
        updateOptionNumbers();
    }

    function removeOption(button) {
        const optionCard = button.closest('.option-card');
        optionCard.remove();
        updateOptionNumbers();
    }

    function updateOptionNumbers() {
        const cards = document.querySelectorAll('.option-card');
        cards.forEach((card, index) => {
            card.querySelector('.option-number').textContent = `é€‰é¡¹ ${index + 1}`;
        });
    }

    // æ¡ä»¶ç»“æœç›¸å…³å‡½æ•°
    let condResultCounters = {};  // è·Ÿè¸ªæ¯ä¸ªé€‰é¡¹çš„æ¡ä»¶ç»“æœæ•°é‡

    function addConditionalResult(optionIndex) {
        const container = document.querySelector(`.conditional-results-container[data-option-index="${optionIndex}"]`);
        if (!condResultCounters[optionIndex]) {
            condResultCounters[optionIndex] = container.querySelectorAll('.conditional-result-item').length;
        }
        const condIndex = condResultCounters[optionIndex]++;

        const html = `
        <div class="conditional-result-item" data-cond-index="${condIndex}">
            <div class="cond-header">
                <span>æ¡ä»¶ ${condIndex + 1}</span>
                <button type="button" class="btn btn-danger btn-small" onclick="removeConditionalResult(this)">åˆ é™¤</button>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>æ¡ä»¶ç±»å‹</label>
                    <select name="option_${optionIndex}_cond_${condIndex}_type" class="cond-type-select" onchange="toggleConditionFields(this)">
                        <option value="attributes">å±æ€§æ¡ä»¶</option>
                        <option value="temp">ä¸´æ—¶å±æ€§</option>
                        <option value="tags">æ ‡ç­¾æ¡ä»¶</option>
                        <option value="default">é»˜è®¤ï¼ˆå…œåº•ï¼‰</option>
                    </select>
                </div>
                
                <!-- Attribute Fields -->
                <div class="form-group cond-field-group cond-attr-fields">
                    <label>å±æ€§å</label>
                    <select name="option_${optionIndex}_cond_${condIndex}_attr">
                        <option value="">--</option>
                        <option value="health">å¥åº·</option>
                        <option value="money">é‡‘é’±</option>
                        <option value="intelligence">æ™ºåŠ›</option>
                        <option value="luck">å¹¸è¿</option>
                        <option value="social">ç¤¾äº¤</option>
                        <option value="san">ç†æ™º</option>
                        <option value="mystery">ç¥ç§˜</option>
                    </select>
                </div>
                <div class="form-group cond-field-group cond-attr-fields">
                    <label>æœ€ä½å€¼</label>
                    <input type="number" name="option_${optionIndex}_cond_${condIndex}_min">
                </div>

                <!-- Temp Fields -->
                <div class="form-group cond-field-group cond-temp-fields" style="display:none">
                    <label>ä¸´æ—¶å±æ€§æœ€ä½å€¼</label>
                    <input type="number" name="option_${optionIndex}_cond_${condIndex}_temp_min">
                </div>

                <!-- Tag Fields -->
                <div class="form-group cond-field-group cond-tag-fields" style="display:none">
                    <label>å¿…éœ€æ ‡ç­¾</label>
                    <input type="text" name="option_${optionIndex}_cond_${condIndex}_tags" placeholder="é€—å·åˆ†éš”">
                </div>
            </div>
            <div class="form-group">
                <label>ç»“æœæè¿° *</label>
                <input type="text" name="option_${optionIndex}_cond_${condIndex}_result" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>æ•ˆæœ (å±æ€§:å€¼)</label>
                    <input type="text" name="option_${optionIndex}_cond_${condIndex}_effects" placeholder="health:10, money:-5">
                </div>
                <div class="form-group">
                    <label>æ·»åŠ æ ‡ç­¾</label>
                    <input type="text" name="option_${optionIndex}_cond_${condIndex}_add_tags" placeholder="é€—å·åˆ†éš”">
                </div>
            </div>
            <div class="form-group">
                <label>åç»­äº‹ä»¶</label>
                <input type="text" name="option_${optionIndex}_cond_${condIndex}_continue" placeholder="äº‹ä»¶IDï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”">
            </div>
        </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
        updateAdvancedStatus(container.closest('.option-card'));
    }

    function removeConditionalResult(button) {
        const card = button.closest('.option-card');
        button.closest('.conditional-result-item').remove();
        updateAdvancedStatus(card);
    }

    function toggleConditionFields(selectElement) {
        const row = selectElement.closest('.form-row');
        const type = selectElement.value;

        // Hide all first
        row.querySelectorAll('.cond-field-group').forEach(el => el.style.display = 'none');

        // Show selected
        if (type === 'attributes') {
            row.querySelectorAll('.cond-attr-fields').forEach(el => el.style.display = 'block');
        } else if (type === 'temp') {
            row.querySelectorAll('.cond-temp-fields').forEach(el => el.style.display = 'block');
        } else if (type === 'tags') {
            row.querySelectorAll('.cond-tag-fields').forEach(el => el.style.display = 'block');
        }
    }

    // åˆå§‹åŒ–å­—æ®µçŠ¶æ€
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.cond-type-select').forEach(select => {
            toggleConditionFields(select);
        });

        // åˆå§‹åŒ–æ‰€æœ‰é€‰é¡¹çš„é«˜çº§è®¾ç½®çŠ¶æ€
        document.querySelectorAll('.option-card').forEach(card => {
            updateAdvancedStatus(card);
        });

        // ç›‘å¬è¡¨å•å˜åŒ–ï¼ŒåŠ¨æ€æ›´æ–°çŠ¶æ€
        document.getElementById('eventForm').addEventListener('input', function (e) {
            const card = e.target.closest('.option-card');
            if (card) {
                updateAdvancedStatus(card);
            }
        });

        // ç›‘å¬ç‚¹å‡»äº‹ä»¶ï¼ˆç‰¹åˆ«æ˜¯å¤é€‰æ¡†å’Œåˆ é™¤æŒ‰é’®ï¼‰
        document.getElementById('eventForm').addEventListener('click', function (e) {
            const card = e.target.closest('.option-card');
            if (card) {
                // å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿ DOM å·²æ›´æ–°ï¼ˆé’ˆå¯¹æ·»åŠ /åˆ é™¤æ“ä½œï¼‰
                setTimeout(() => updateAdvancedStatus(card), 10);
            }
        });
    });

    /**
     * æ›´æ–°é«˜çº§è®¾ç½®çš„çŠ¶æ€æç¤º
     */
    function updateAdvancedStatus(card) {
        const advancedSection = card.querySelector('.advanced-settings');
        if (!advancedSection) return;

        const statusLabel = advancedSection.querySelector('.advanced-status');
        if (!statusLabel) return;

        let isEnabled = false;

        // 1. æ£€æŸ¥ç›´æ¥è®¾ç½®å±æ€§ (set_attributes)
        const setAttrs = advancedSection.querySelectorAll('input[name*="_set_"]');
        for (let input of setAttrs) {
            if (input.value.trim() !== '') {
                isEnabled = true;
                break;
            }
        }

        // 2. æ£€æŸ¥åç»­äº‹ä»¶ã€é£é™©ã€æ­»äº¡æè¿°
        if (!isEnabled) {
            const fields = [
                card.querySelector('input[name*="_continue_event_"]'),
                card.querySelector('input[name*="_risk_"]'),
                card.querySelector('input[name*="_death_reason_"]')
            ];
            for (let f of fields) {
                if (f && f.value.trim() !== '') {
                    isEnabled = true;
                    break;
                }
            }
        }

        // 3. æ£€æŸ¥æ­»äº¡æ ‡å¿— (checkbox)
        if (!isEnabled) {
            const deathFlag = card.querySelector('input[name*="_death_flag_"]');
            if (deathFlag && deathFlag.checked) {
                isEnabled = true;
            }
        }

        // 4. æ£€æŸ¥æ¡ä»¶ç»“æœ (structured)
        if (!isEnabled) {
            const condItems = advancedSection.querySelectorAll('.conditional-result-item');
            if (condItems.length > 0) {
                isEnabled = true;
            }
        }

        // 5. æ£€æŸ¥æ¡ä»¶ç»“æœ (JSON textarea)
        if (!isEnabled) {
            const jsonFallback = advancedSection.querySelector('textarea[name*="_conditional_results_"]');
            if (jsonFallback && jsonFallback.value.trim() !== '' && jsonFallback.value.trim() !== '[]' && jsonFallback.value.trim() !== 'null') {
                isEnabled = true;
            }
        }

        // æ›´æ–° UI
        if (isEnabled) {
            statusLabel.textContent = 'å·²å¯ç”¨';
            statusLabel.classList.remove('status-disabled');
            statusLabel.classList.add('status-enabled');
        } else {
            statusLabel.textContent = 'æœªå¯ç”¨';
            statusLabel.classList.remove('status-enabled');
            statusLabel.classList.add('status-disabled');
        }
    }
</script>
{% endblock %}